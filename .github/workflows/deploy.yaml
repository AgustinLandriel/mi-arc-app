name: Deploy con ARC

on:
    push: 
        branches: [main]
    workflow_dispatch:

jobs:
    deploy:
        runs-on: mi-runners #usa el runnner de ARC

        steps:
            - name: Checkout del codigo
              uses: actions/checkout@v4

            - name: Ver info del runner
              run: |
                echo "üèÉ‚Äç‚ôÇÔ∏è Ejecut√°ndose en runner ARC"
                echo "Hostname: $(hostname)"
                echo "Usuario: $(whoami)"

            - name: Instalar kubectl
              run: |
                    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                    chmod +x kubectl
                    sudo mv kubectl /usr/local/bin/
                    
            - name: Probar version
              run: kubectl version --client

            - name: Verificar cluster
              run: |
                echo "üîç Verificando conexi√≥n a Kubernetes..."
                kubectl get nodes
                kubectl get namespaces

            - name: Aplicar Manifestos
              run: |
                echo "Desplegando aplicacion"
                kubectl apply -f k8s/deployment.yaml
                kubectl apply -f k8s/service.yaml

            - name: "Esperar despliegue..."
              run: kubectl rollout status deployment/arc-demo-app --timeout=300s

            - name: "Verificar resultado"
              run: |
                    echo "estado final:"
                    kubectl get pods -l app=demo-app
                    kubectl get svc arc-demo-service
                    echo "Aplicacion disponible en:"
                    kubectl port-forward svc/arc-demo-service 8080:80
                    echo "http://localhost:30080"
